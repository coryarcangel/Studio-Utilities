app.Visible = false;var config = {};getConfigFromEnv();app.displayDialogs = DialogModes.NO;function registerSessionAction(){        $.setenv("resize-session", new Date());}function clearSessionCount(){        $.setenv("count-session", 0);}function incrementSessionCount(){        $.setenv("count-session", parseInt($.getenv("count-session"))+1);}function getSessionCount(){        return $.getenv("count-session");        }function timeSinceLastSessionAction(){        return new Date - new Date($.getenv("resize-session"));}function getConfigFromDialog(){    var settings = setupWindow();    config.title = settings['title'].text.toString();    config.year = settings['year'].text.toString();    config.inventory = settings['catnum'].text.toString();    setConfigFromEnv()}function getConfigFromEnv(){    if($.getenv("title")){        config.title = $.getenv("title");        config.year = $.getenv("year");        config.inventory = $.getenv("inventory");    }    else{        config = {};        }}function setConfigFromEnv(){    $.setenv("title",config.title );    $.setenv("year",config.year );    $.setenv("inventory",config.inventory );}function setupWindow(){    clearSessionCount();    var w = new Window ('dialog', 'arcangel studio image resize wizard :)', [0, 0, 480, 170]);    w.cancel = false;    var showingNumber = false;    var leftGutter = 15;    //var thefile = File.saveDialog("Select the 'images' ");    w.add ('statictext', [leftGutter, 15, 150, 35], 'artwork title:');    w.title = w.add ('edittext', [100, 15, 260, 35], 'artwork-title');    w.add ('statictext', [leftGutter, 45, 125, 65], 'year and/or inv. #:');    var inventoryFieldXOffset = 30;    w.year = w.add ('edittext', [inventoryFieldXOffset+100, 45, inventoryFieldXOffset+150, 65], new Date().getFullYear());    w.year.value = new Date().getFullYear();    w.add ('statictext', [inventoryFieldXOffset+153, 45, inventoryFieldXOffset+165, 65], '-');    w.catnum = w.add ('edittext', [inventoryFieldXOffset+165, 45, inventoryFieldXOffset+200, 65], 'XX');    w.catnum.value = "XX";    w.center();    w.ok = w.add ('button', [350, 140, 410, 160], 'OK', { name:'ok' });    w.cancelButton = w.add ('button', [405, 140, 470, 160], 'CANCEL',{name: "cancel"});    w.result = w.show();    return w;}function logConfig(){    for(c in config){        $.writeln(c+": "+config[c]);    }}var sessionCount = getSessionCount();if(timeSinceLastSessionAction()>5000){    $.writeln("new session, opening window.");    getConfigFromDialog();    logConfig();}$.writeln("processing image now");var doc = app.activeDocument; var work_folder = new Folder("~/Desktop/PANTS-EXPORT");if(!work_folder.exists){    work_folder.create();}exportPrintFiles(config.title +"-"+config.year+"-"+config.inventory+"-master");function exportPrintFiles(filename){var res = doc.resolution;var panelNames = ['top','middle','bottom'];var margin = res*1.5;var saveOpts = new TiffSaveOptions();    saveOpts.layers = false;    saveOpts.imageCompression = TIFFEncoding.TIFFLZW;    saveOpts.alphaChannels = false;app.displayDialogs = DialogModes.NO;for(var i=0;i<3;i++){    var outfile = new File('~/Desktop/PANTS-EXPORT/'+filename+'-'+panelNames[i]+'-panel.tif');    cropSaveUndo(i,outfile,saveOpts);        if(doc.layers.length>(i+1) && doc.layers[i+1].layerMaskDensity !== 100)        doc.layers[i+1].layerMaskDensity = 100;}var sightRegion = Array (Array(margin, margin),Array(doc.width-margin,margin),       Array(doc.width-margin, doc.height-margin),       Array(margin, doc.height-margin));doc.selection.select(sightRegion);doc.crop(doc.selection.bounds);doc.flatten();function cropSaveUndo(layerIndex,file,saveOptions){    var printRegion = Array(Array(0, (36*i*res)),Array(doc.width,(36*i*res)),       Array(doc.width, 2*margin+(36*(i+1)*res)),       Array(0,  2*margin+(36*(i+1)*res)),       Array(0,(36*i*res)));     if(doc.layers.length>(i+1) && doc.layers[i+1].layerMaskDensity !== 0)     try{        doc.layers[i+1].layerMaskDensity = 0;}    catch (error){$.writeln(error);}    doc.selection.select(printRegion);    doc.crop(doc.selection.bounds);    doc.saveAs(file,saveOptions, true);    $.writeln("after: ",doc.historyStates.length);    doc.activeHistoryState = doc.historyStates[doc.historyStates.length-2];    }        }var randomHash = randomString(4);var thisSession = 0;logConfig();if(true){    //do not include "type" anymore in filename.  "+config.inventory+"-"+config.type+"........    var outfile = new File(work_folder+"/"+ config.title +"-"+config.year+"-"+config.inventory+"-press-ih-"+randomHash+".tif");    var resampleMethod = ResampleMethod.BILINEAR;    if(config.type){        resampleMethod = ResampleMethod.NEARESTNEIGHBOR;     }    if(doc.width.value < doc.height.value){        doc.resizeImage(undefined,"12in",300,resampleMethod);      }    else {         doc.resizeImage("12in",undefined,300,resampleMethod);    }    var tiffOptions = new TiffSaveOptions();    tiffOptions.imageCompression = TIFFEncoding.TIFFLZW;    tiffOptions.alphaChannels = false;    tiffOptions.layers = false;    if(!outfile.exists){        doc.saveAs(outfile, tiffOptions);    }}if(true){    $.writeln(app.activeDocument);    var outfile = new File(work_folder+"/"+ config.title +"-"+config.year+"-"+config.inventory+"-web-ih-"+"-"+randomHash+".jpg");    $.writeln("    making db image");    doc.resizeImage("1400px",undefined,72);    var opts = JPEGSaveOptions();    opts.quality = 9;      if(!outfile.exists)          doc.saveAs(outfile,opts);           doc.close(SaveOptions.DONOTSAVECHANGES);}if(true){    $.writeln(app.activeDocument);    var outfile = new File(work_folder+"/"+ config.title +"-"+config.year+"-"+config.inventory+"-database-ih-"+"-"+randomHash+".jpg");    $.writeln("    making db image");    doc.resizeImage("800px",undefined,72);      if(!outfile.exists)          doc.saveAs(outfile,new JPEGSaveOptions());           doc.close(SaveOptions.DONOTSAVECHANGES);}//will this get us back to normal?doc.activeHistoryState = doc.historyStates[doc.historyStates.length-2];function randomString(len){    var text = "";    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";    for(var i = 0; i < len; i++) {        text += possible.charAt(Math.floor(Math.random() * possible.length));    }    return text;  }incrementSessionCount();registerSessionAction()